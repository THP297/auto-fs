<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discount Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 300;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 1.1em;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            min-height: 100px;
        }

        .result-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-content {
            color: #666;
            line-height: 1.6;
            font-size: 1.1em;
        }

        .highlight {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Auto Flash Sale</h1>
         
        <form id="discountForm">
            <div class="form-group">
                <label for="discount">Khuyến Mãi:</label>
                <input type="number" id="discount" name="discount" min="0" max="100" step="0.01" placeholder="Enter discount percentage" required>
            </div>
            
            <div class="form-group">
                <label for="number">SL sản phẩm khuyến mãi:</label>
                <input type="number" id="number" name="number" min="0" step="0.01" placeholder="Enter a number" required>
            </div>
            
            <button type="submit" class="submit-btn">Calculate</button>
        </form>
        
        <div class="result-section">
            <div class="result-title">Code:</div>
            <div class="result-content" id="resultContent">
                Enter values above and click Calculate to see the result.
            </div>
        </div>
    </div>

    <script>
        // Store the js.txt content
        const jsContent = `
// Load jQuery and proceed with callback
function loadJQuery(callback) {
    var script = document.createElement('script');
    script.src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js";
    script.type = 'text/javascript';
    script.onload = callback;
    document.head.appendChild(script);
}

// Simulate typing into an input field
function simulateTyping(value, selector, index, callback) {
    var input = $(selector).eq(index)[0];
    var index = 0;

    function typeCharacter() {
        if (index < value.length) {
            var char = value[index];
            var eventKeydown = new KeyboardEvent('keydown', { key: char });
            var eventKeypress = new KeyboardEvent('keypress', { key: char });
            var eventKeyup = new KeyboardEvent('keyup', { key: char });

            input.dispatchEvent(eventKeydown);
            input.dispatchEvent(eventKeypress);
            input.value += char;
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(eventKeyup);
            
            index++;
            setTimeout(typeCharacter, 100); // Simulate typing speed
        } else if (callback) {
            setTimeout(callback, 500); // Wait briefly before proceeding
        }
    }

    typeCharacter();
}

// Click a checkbox input
function clickCheckbox(selector, callback) {
    var checkbox = $(selector).first();

    if (checkbox.length > 0) {
        checkbox.click(); // Simulate the click event
        if (callback) {
            setTimeout(callback, 500); // Wait briefly before proceeding
        }
    } else {
        console.log("Checkbox not found");
    }
}

// Click a button using a selector
function clickCapNhatButton(selector, callback) {
    var button = $(selector).first();

    if (button.length > 0) {
        button.click(); // Simulate the click event
        if (callback) {
            setTimeout(callback, 500); // Wait briefly before proceeding
        }
    } else {
        console.log("Button not found");
    }
}

// Click a button and wait for next step
function clickButtonTimeSlot(selector, callback) {
    var button = $(selector).first();

    if (button.length > 0) {
        button.click(); // Simulate the click event
        if (callback) {
            setTimeout(callback, 500); // Wait briefly before proceeding
        }
    } else {
        console.log("Button not found");
    }
}

// Click the first date cell with "slots-count"
function clickFirstDateWithSlots(selector, callback) {
    setTimeout(function() {
        var dateCell = $(selector).find('p.slots-count').first().closest(selector);

        if (dateCell.length > 0) {
            dateCell.click(); // Simulate the click event
            if (callback) {
                setTimeout(callback, 500); // Wait briefly before proceeding
            }
        } else {
            console.log("Date cell with slots-count not found");
        }
    }, 2000); // 2000 milliseconds = 2 seconds
}

// Click the first radio button input in the table
function clickFirstRadio(selector, callback) {
    setTimeout(() => {
        var radioInput = $(selector).find('input[type="radio"]').first();

        if (radioInput.length > 0) {
            radioInput.click(); // Simulate the click event
            if (callback) {
                setTimeout(callback, 500); // Wait briefly before proceeding
            }
        } else {
            console.log("Radio input not found");
        }
    }, 1000);
}

// Click the confirm button in the footer
function clickFooterConfirmButton(selector, callback) {
    setTimeout(() => {
        var footerConfirmButton = $(selector).first();

        if (footerConfirmButton.length > 0) {
            footerConfirmButton.click(); // Simulate the click event
            if (callback) {
                setTimeout(callback, 500); // Wait briefly before proceeding
            }
        } else {
            console.log("Footer confirm button not found");
        }
    }, 1000);
}

// Click the button with text "Bật"
function clickEnableButton(callback) {
    setTimeout(() => {
        var buttons = document.querySelectorAll('button.eds-button.eds-button--normal');
        var enableButton = Array.from(buttons).find(button => button.textContent.trim() === "Bật");

        if (enableButton) {
            if (enableButton.offsetParent !== null) { // Check if element is visible
                enableButton.click(); // Simulate the click event
                if (callback) {
                    setTimeout(callback, 500); // Wait briefly before proceeding
                }
            } else {
                console.log("Enable button is not visible or clickable");
            }
        } else {
            console.log("Enable button not found");
        }
    }, 1000);
}

// Click the "Xác nhận" button
function clickXacNhanButton(callback) {
    setTimeout(() => {
        // Exact match on the span's text
        const xacNhanButton = $('button.eds-button.eds-button--primary.eds-button--normal').filter(function () {
          return $(this).children('span').first().text().trim() === 'Xác nhận';
        });

        if (xacNhanButton) {
            if (xacNhanButton.offsetParent !== null) { // Check if element is visible
                xacNhanButton.click(); // Simulate the click event
                if (callback) {
                    setTimeout(callback, 500); // Wait briefly before proceeding
                }
            } else {
                console.log("Xác nhận button is not visible or clickable");
            }
        } else {
            console.log("Xác nhận button not found");
        }
    }, 3000);
}

// Click the "Quay lại trang Danh sách" button (includes check)
function clickQuayLaiTrangDanhSachButton(callback) {
  setTimeout(() => {
    const quayLaiButton = $('button.eds-button.eds-button--primary.eds-button--normal')
      .filter(function () {
        const text = $(this).find('span').first().text().trim();
        return text.includes('Quay lại trang Danh sách'); // dùng includes thay vì ===
      })
      .first(); // lấy phần tử đầu tiên phù hợp

    if (quayLaiButton.length) {
      if (quayLaiButton.is(':visible') && !quayLaiButton.is(':disabled')) {
        quayLaiButton.trigger('click'); // click bằng jQuery an toàn
        if (typeof callback === 'function') {
          setTimeout(callback, 500);
        }
      } else {
        console.log('Quay lại trang Danh sách button is not visible or clickable');
      }
    } else {
      console.log('Quay lại trang Danh sách button not found');
    }
  }, 1000);
}

// Load jQuery and proceed with callback
loadJQuery(function() {
    // Execute the series of actions
    executeActions();
});

function executeActions() {
    // Step 0: Simulate typing % discount
    simulateTyping(discountNumber, '.eds-input__input', 0, function() {
        // Step 1: Simulate typing
        simulateTyping(numberProductDiscount, '.eds-input__input', 1, function() {
            // Step 2: Click checkbox
            clickCheckbox('.eds-checkbox__input', function() {
                // Step 3: Click "Cập nhật được chọn" button
                clickCapNhatButton('.action-button.eds-button.eds-button--normal', function() {
                    // Step 4: Click time slot button
                    clickButtonTimeSlot('.eds-button.eds-button--primary.eds-button--normal.eds-button--outline.time-slot-btn', function() {
                        // Step 5: Click first date cell with slots
                        clickFirstDateWithSlots('.eds-date-table__cell', function() {
                            // Step 6: Click first radio button in table
                            clickFirstRadio('.eds-table__body', function() {
                                // Step 7: Click confirm button in footer
                                clickFooterConfirmButton('.footer-action .confirm-btn', function() {
                                    // Step 8: Click "Bật" button
                                    clickEnableButton(function() {
                                        // Step 9: Click "Xác nhận" button
                                        clickXacNhanButton(function() {
                                            // Step 10: Click "Quay lại trang Danh sách" button
                                            clickQuayLaiTrangDanhSachButton(function() {
                                                console.log("Waiting for page to reload...");
                                                // Step 11: Wait for the table to update and then click the first "Sao chép" button
                                                waitForTableUpdate(function() {
                                                    clickFirstSaoChepButton();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
}

function waitForTableUpdate(callback) {
    var checkExist = setInterval(function() {
        var targetNode = document.querySelector('tbody[data-v-06e73db8]');
        if (targetNode) {
clearInterval(checkExist);

            // Options for the observer (which mutations to observe)
            var config = { childList: true, subtree: true };

            // Callback function to execute when mutations are observed
            var observerCallback = function(mutationsList, observer) {
                for (var mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                        console.log('Table updated');
                        // Disconnect the observer once the table is updated
                        observer.disconnect();
                        // Execute the callback function
                        if (callback) callback();
                        break;
                    }
                }
            };

            // Create an observer instance linked to the callback function
            var observer = new MutationObserver(observerCallback);

            // Start observing the target node for configured mutations
            observer.observe(targetNode, config);

            // Fallback in case MutationObserver doesn't trigger
            setTimeout(function() {
                observer.disconnect();
                if (callback) callback();
            }, 5000); // Adjust timeout as needed
        }
    }, 100); // Adjust interval as needed
}

function clickFirstSaoChepButton() {
    var buttons = Array.from(document.querySelectorAll('button'));
    var saoChepButton = buttons.find(button => button.textContent.includes('Sao chép'));
    if (saoChepButton) {
        // Open the new tab and keep a reference to it
        var newTab = window.open('', '_blank');
        
        var event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true
        });

        // Modify the event to open the link in the new tab
        saoChepButton.addEventListener('click', function() {
            setTimeout(function() {
                if (newTab) {
                    newTab.location.href = saoChepButton.href;
                    newTab.onload = function() {
                        // Run your function in the new tab
                        newTab.runFunctionInNewTab();
                    };
                }
            }, 100);
        });

        saoChepButton.dispatchEvent(event);
        console.log("Clicked the first 'Sao chép' button");
    } else {
        console.log("No 'Sao chép' button found");
    }
}

// Function to run in the new tab
function runFunctionInNewTab() {
    console.log("Running function in the new tab");
    // Your code here to interact with the new tab
}
                `;

        document.getElementById('discountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get the input values
            const discount = document.getElementById('discount').value;
            const number = document.getElementById('number').value;
            
            // Log the values to console
            console.log('User Input:');
            console.log('Discount Percentage:', discount + '%');
            console.log('Number:', number);
            
            // Replace variables in the js content
            const modifiedJsContent = jsContent
                .replace(/discountNumber/g, `"${discount}"`)
                .replace(/numberProductDiscount/g, `"${number}"`);
            
            // Display the modified code in the result section
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div style="position: relative;">
                    <button id="copyButton" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; z-index: 10;" onmouseover="this.style.background='#5a6fd8'" onmouseout="this.style.background='#667eea'">
                        📋 Copy to Clipboard
                    </button>
                    <pre id="codeContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; max-height: 400px; overflow-y: auto; border: 1px solid #e1e5e9;">
${modifiedJsContent}
                    </pre>
                </div>

            `;
            
            // Add copy functionality
            document.getElementById('copyButton').addEventListener('click', function() {
                const codeText = document.getElementById('codeContent').textContent;
                navigator.clipboard.writeText(codeText).then(function() {
                    const button = document.getElementById('copyButton');
                    const originalText = button.textContent;
                    button.textContent = '✅ Copied!';
                    button.style.background = '#28a745';
                    setTimeout(function() {
                        button.textContent = originalText;
                        button.style.background = '#667eea';
                    }, 2000);
                }).catch(function(err) {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy to clipboard. Please try again.');
                });
            });
            
            // Also log the modified content
            console.log('Modified JavaScript Code:');
            console.log(modifiedJsContent);
        });
    </script>
</body>
</html>
